<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zebone.dip.metadata.dao.FieldConfMapper" >
  <resultMap id="FieldConfMap" type="com.zebone.dip.metadata.vo.FieldConf" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 25 08:51:07 CST 2013.
    -->
    <id column="ID_" property="id" jdbcType="VARCHAR" />
    <result column="FIELD_NAME" property="fieldName" jdbcType="VARCHAR" />
    <result column="FIELD_DESC" property="fieldDesc" jdbcType="VARCHAR" />
    <result column="FIELD_CODE" property="fieldCode" jdbcType="VARCHAR" />
    <result column="FIELD_TYPE" property="fieldType" jdbcType="VARCHAR" />
    <result column="FIELD_VALUE" property="fieldValue" jdbcType="VARCHAR" />
    <result column="FIELD_FORMAT" property="fieldFormat" jdbcType="VARCHAR" />
    <result column="ONLY_CODE" property="onlyCode" jdbcType="VARCHAR" />
    <result column="FIELD_RULE" property="fieldRule" jdbcType="VARCHAR" />
    <result column="IS_DELETED" property="isDeleted" jdbcType="VARCHAR" />
    <result column="FIELD_ID" property="fieldId" jdbcType="VARCHAR" />
    <result column="FIELD_RULE_FORMAT" property="fieldRuleFormat" jdbcType="VARCHAR" />
    <result column="ONLY_SORT" property="onlySort" jdbcType="VARCHAR" />
    <result column="FIELD_VALNAME" property="fieldValname" jdbcType="VARCHAR" />
    <result column="CREATE_TIME" property="createTime" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="FieldConfList" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 25 08:51:07 CST 2013.
    -->
    ID_, FIELD_NAME, FIELD_DESC, FIELD_CODE, FIELD_TYPE, FIELD_VALUE, 
    FIELD_FORMAT, ONLY_CODE, FIELD_RULE,IS_DELETED,FIELD_ID,FIELD_RULE_FORMAT,ONLY_SORT,FIELD_VALNAME,CREATE_TIME
  </sql>
  <select id="selectByPrimaryKey" resultMap="FieldConfMap" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 25 08:51:07 CST 2013.
    -->
    select 
    <include refid="FieldConfList" />
    from P_FIELD_CONF
    where ID_ = #{id,jdbcType=VARCHAR} and IS_DELETED = 0
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 25 08:51:07 CST 2013.
    -->
    delete from P_FIELD_CONF
    where ID_ = #{id,jdbcType=VARCHAR}
  </delete>
  <insert id="insertSelective" parameterType="com.zebone.dip.metadata.vo.FieldConf" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 25 08:51:07 CST 2013.
    -->
    insert into P_FIELD_CONF
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        ID_,
      </if>
      <if test="fieldName != null" >
        FIELD_NAME,
      </if>
      <if test="fieldDesc != null" >
        FIELD_DESC,
      </if>
      <if test="fieldCode != null" >
        FIELD_CODE,
      </if>
      <if test="fieldType != null" >
        FIELD_TYPE,
      </if>
      <if test="fieldValue != null" >
        FIELD_VALUE,
      </if>
      <if test="fieldFormat != null" >
        FIELD_FORMAT,
      </if>
      <if test="onlyCode != null" >
        ONLY_CODE,
      </if>
      <if test="fieldRule != null" >
        FIELD_RULE,
      </if>
      <if test="fieldId != null" >
        FIELD_ID,
      </if>
      <if test="fieldRuleFormat != null" >
        FIELD_RULE_FORMAT,
      </if>
      <if test="onlySort != null" >
        ONLY_SORT,
      </if>
      <if test="fieldValname != null" >
        FIELD_VALNAME,
      </if>
      <if test="createTime != null" >
        CREATE_TIME,
      </if>
      <if test="1==1">
        TIMESTAMP,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="fieldName != null" >
        #{fieldName,jdbcType=VARCHAR},
      </if>
      <if test="fieldDesc != null" >
        #{fieldDesc,jdbcType=VARCHAR},
      </if>
      <if test="fieldCode != null" >
        #{fieldCode,jdbcType=VARCHAR},
      </if>
      <if test="fieldType != null" >
        #{fieldType,jdbcType=VARCHAR},
      </if>
      <if test="fieldValue != null" >
        #{fieldValue,jdbcType=VARCHAR},
      </if>
      <if test="fieldFormat != null" >
        #{fieldFormat,jdbcType=VARCHAR},
      </if>
      <if test="onlyCode != null" >
        #{onlyCode,jdbcType=VARCHAR},
      </if>
      <if test="fieldRule != null" >
        #{fieldRule,jdbcType=VARCHAR},
      </if>
      <if test="fieldId != null" >
        #{fieldId,jdbcType=VARCHAR},
      </if>
      <if test="fieldRuleFormat != null" >
        #{fieldRuleFormat,jdbcType=VARCHAR},
      </if>
      <if test="onlySort != null" >
        #{onlySort,jdbcType=VARCHAR},
      </if>
      <if test="fieldValname != null" >
        #{fieldValname,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=VARCHAR},
      </if>
      <if test="1==1" >
        CURRENT_TIMESTAMP,
      </if>
     
    </trim>
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.zebone.dip.metadata.vo.FieldConf" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jun 25 08:51:07 CST 2013.
      FIELD_FORMAT = #{fieldFormat,jdbcType=VARCHAR},
      FIELD_LENGTH = #{fieldLength,jdbcType=VARCHAR},
    -->
    update P_FIELD_CONF
    set FIELD_NAME = #{fieldName,jdbcType=VARCHAR},
      FIELD_DESC = #{fieldDesc,jdbcType=VARCHAR},
      FIELD_CODE = #{fieldCode,jdbcType=VARCHAR},
      FIELD_TYPE = #{fieldType,jdbcType=VARCHAR},
      FIELD_VALUE = #{fieldValue,jdbcType=VARCHAR},
      FIELD_FORMAT = #{fieldFormat,jdbcType=VARCHAR},
      ONLY_CODE = #{onlyCode,jdbcType=VARCHAR},
      FIELD_RULE = #{fieldRule,jdbcType=VARCHAR},
      FIELD_RULE_FORMAT = #{fieldRuleFormat,jdbcType=VARCHAR},
      ONLY_SORT = #{onlySort,jdbcType=VARCHAR},
      FIELD_VALNAME = #{fieldValname,jdbcType=VARCHAR},
      FIELD_ID = #{fieldId,jdbcType=VARCHAR},
      TIMESTAMP=CURRENT_TIMESTAMP
    where ID_ = #{id,jdbcType=VARCHAR}
  </update>
  <select id="metadataList" parameterType="com.zebone.dip.metadata.vo.FieldConf"  resultMap="FieldConfMap">
  	SELECT A.ID_,A.FIELD_NAME,A.FIELD_CODE,A.FIELD_ID,B.DICT_NAME AS ONLY_SORT,A.FIELD_VALNAME,A.FIELD_TYPE,A.FIELD_FORMAT
	FROM P_FIELD_CONF A
	LEFT JOIN BTP_DICTIONARY B ON A.ONLY_SORT = B.DICT_CODE 
	AND B.DICTTYPE_ID = 'bf2e33177162477ab2fb9f4bc7269bb0'
	AND B.IS_DELETED = 0
    <where>
    	A.IS_DELETED = 0 
    	<if test="fieldName != null and fieldName !=''">
    		and A.FIELD_NAME LIKE '%' || #{fieldName,jdbcType=VARCHAR} || '%' escape '/'
    	</if>
    	<if test="fieldId != null and fieldId !=''">
    		and A.FIELD_ID = #{fieldId,jdbcType=VARCHAR}
    	</if>
    	<if test="onlySort != null and onlySort !=''">
    		and A.ONLY_SORT = #{onlySort,jdbcType=VARCHAR}
    	</if>
    </where>
    order by CREATE_TIME DESC
  </select>
  <select id="metadataTotalCount" resultType="int" parameterType="com.zebone.dip.metadata.vo.FieldConf">
  	select count(ID_)
    from P_FIELD_CONF
    <where>
    	IS_DELETED = 0 
    	<if test="fieldName != null and fieldName !=''">
    		and FIELD_NAME LIKE '%' || #{fieldName,jdbcType=VARCHAR} || '%' escape '/'
    	</if>
    	<if test="fieldId != null and fieldId !=''">
    		and FIELD_ID = #{fieldId,jdbcType=VARCHAR}
    	</if>
    	<if test="onlySort != null and onlySort !=''">
    		and ONLY_SORT = #{onlySort,jdbcType=VARCHAR}
    	</if>
    </where>
  </select>
  <select id="metadataExistsDocMap" parameterType="java.lang.String" resultType="int">
  	SELECT COUNT(T.ID_) FROM P_DOC_MAPPING T 
	WHERE EXISTS
	(SELECT 'X' FROM P_FIELD_CONF M WHERE M.ID_ = T.FIELD_ID AND M.ID_ = #{id,jdbcType=VARCHAR})
  </select>
  <select id="metadataExistsDataSet" parameterType="java.lang.String" resultType="int">
  	SELECT COUNT(T.ID_) FROM P_DATASET_MAPPING T 
	WHERE EXISTS
	(SELECT 'X' FROM P_FIELD_CONF M WHERE M.ID_ = T.FIELD_ID AND M.ID_ = #{id,jdbcType=VARCHAR})
  </select>
  <update id="deleteMetadataByIds">
	UPDATE P_FIELD_CONF SET IS_DELETED = 1 , TIMESTAMP=CURRENT_TIMESTAMP WHERE 
	<foreach collection="list" item="item" index="index" separator="OR">
		(ID_ = #{item,jdbcType=VARCHAR})
	</foreach>
  </update>
  <select id="getMetadatasByQuery" parameterType="com.zebone.dip.metadata.vo.FieldConf"  resultMap="FieldConfMap">
  	<![CDATA[
  	SELECT T.ID_,T.FIELD_NAME,T.FIELD_ID,T.FIELD_CODE FROM P_FIELD_CONF T
	WHERE T.IS_DELETED = 0 AND (T.FIELD_NAME LIKE '%' || #{fieldName,jdbcType=VARCHAR} || '%' OR T.FIELD_ID LIKE '%' || #{fieldName,jdbcType=VARCHAR} || '%')
	AND ROWNUM <= 10
	]]>
  </select>
  <select id="datasetMetadataList" parameterType="com.zebone.dip.metadata.vo.FieldConf" resultMap="FieldConfMap">
  	SELECT 
	A.ID_,B.FIELD_NAME,B.FIELD_ID,B.FIELD_CODE,A.FIELD_NAME AS FIELD_DESC
	FROM P_DATASET_MAPPING A
	LEFT JOIN P_FIELD_CONF B ON A.FIELD_ID = B.ID_ AND B.IS_DELETED = 0
	<where>
		A.DATASET_ID = #{id,jdbcType=VARCHAR}
		<if test="fieldName != null and fieldName !=''">
			AND A.FIELD_NAME LIKE '%' || #{fieldName,jdbcType=VARCHAR} || '%'
		</if>
	</where>
  </select>
  <select id="datasetMetadataCount" parameterType="java.lang.String" resultType="int">
  	SELECT 
	COUNT(A.ID_)
	FROM P_DATASET_MAPPING A
	LEFT JOIN P_FIELD_CONF B ON A.FIELD_ID = B.ID_ AND B.IS_DELETED = 0
	<where>
		A.DATASET_ID = #{id,jdbcType=VARCHAR}
		<if test="fieldName != null and fieldName !=''">
			AND A.FIELD_NAME LIKE '%' || #{fieldName,jdbcType=VARCHAR} || '%'
		</if>
	</where>
  </select>
  <select id="metadataListBydataset" resultMap="FieldConfMap" parameterType="com.zebone.dip.metadata.vo.DataSetConf">
  	SELECT 
	A.ID_ AS IS_DELETED,B.ID_,A.FIELD_NAME,B.FIELD_ID,B.FIELD_CODE
	FROM P_DATASET_MAPPING A
	LEFT JOIN P_FIELD_CONF B ON A.FIELD_ID = B.ID_ AND B.IS_DELETED = 0
	<where>
		A.DATASET_ID = #{id,jdbcType=VARCHAR}
		<if test="fieldName != null and fieldName !=''">
			AND A.FIELD_NAME LIKE '%' || #{fieldName,jdbcType=VARCHAR} || '%'
		</if>
	</where>
  </select>
  <select id="metadataTotalCountBydataset" resultType="int" parameterType="com.zebone.dip.metadata.vo.DataSetConf">
  	SELECT 
	COUNT(A.ID_)
	FROM P_DATASET_MAPPING A
	LEFT JOIN P_FIELD_CONF B ON A.FIELD_ID = B.ID_ AND B.IS_DELETED = 0
	<where>
		A.DATASET_ID = #{id,jdbcType=VARCHAR}
		<if test="fieldName != null and fieldName !=''">
			AND A.FIELD_NAME LIKE '%' || #{fieldName,jdbcType=VARCHAR} || '%'
		</if>
	</where>
  </select>
  <select id="getFieldIdByFieldCode" parameterType="java.lang.String" resultType="java.lang.String">
  	SELECT
	T.ID_
	FROM P_FIELD_CONF T
	WHERE T.FIELD_CODE = #{fieldCode,jdbcType=VARCHAR} AND T.IS_DELETED = 0
  </select>
  
  <!-- 根据数据源编码获取数据元 -->
  <select id="selectByFCode" parameterType="com.zebone.dip.metadata.vo.FieldConf" resultMap="FieldConfMap">
  	SELECT 
  	    <include refid="FieldConfList"/>
  	FROM P_FIELD_CONF
  	WHERE FIELD_CODE = #{fieldCode,jdbcType=VARCHAR}  AND IS_DELETED = 0
  </select>
  
    <!-- 根据数据源标识符获取数据元 -->
  <select id="selectByFieldId" parameterType="string" resultMap="FieldConfMap">
  	SELECT 
  	    <include refid="FieldConfList"/>
  	FROM P_FIELD_CONF
  	WHERE FIELD_ID = #{fieldId,jdbcType=VARCHAR}  AND IS_DELETED = 0
  </select>
  <select id="isExistsFieldCode" parameterType="java.lang.String" resultType="int">
  	SELECT COUNT(T.ID_) FROM P_FIELD_CONF T WHERE T.IS_DELETED = 0 AND T.FIELD_CODE = #{fieldCode,jdbcType=VARCHAR}
  	<if test="id!=''">
  		AND T.ID_ != #{id,jdbcType=VARCHAR}
  	</if>
  </select>
  <select id="isExistsFieldId" parameterType="java.lang.String" resultType="int">
  	SELECT COUNT(T.ID_) FROM P_FIELD_CONF T WHERE T.IS_DELETED = 0 AND T.FIELD_ID = #{fieldId,jdbcType=VARCHAR}
  	<if test="id!=''">
  		AND T.ID_ != #{id,jdbcType=VARCHAR}
  	</if>
  </select><!-- 
  <select id="getDictInfoByName" parameterType="java.lang.String" resultType="com.zebone.btp.app.dict.pojo.DictionaryType">
  	<![CDATA[
  	SELECT T.TYPE_ID AS typeId,T.TYPE_NAME AS typeName,T.TYPE_CODE AS typeCode
  	FROM BTP_DICTIONARY_TYPE T 
  	WHERE T.IS_DELETED = 0 AND T.TYPE_NAME LIKE '%'|| #{name,jdbcType=VARCHAR} ||'%'
  	AND ROWNUM <= 10
	]]>
  </select> -->
  <select id="getDictInfo2ByName" parameterType="java.lang.String" resultType="com.zebone.btp.app.dict.pojo.DictionaryType">
  	<![CDATA[
  	SELECT T.ID_ AS typeId,T.CODE AS typeCode,T.NAME AS typeName FROM P_MASTER_DATA T WHERE T.NAME LIKE '%'|| #{name,jdbcType=VARCHAR} ||'%'
  	AND ROWNUM <= 10
	]]>
  </select>
</mapper>